<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Shia Islamic Adventure Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&amp;family=Fredoka:wght@400;500&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.13/lottie.min.js"></script>
    <script defer="" type="module">
        // Import Firebase libraries
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBD2asTEG40b4hhVmUZKlGd3ZPe-NJctxM",
            authDomain: "shia-kids-learning-tool.firebaseapp.com",
            projectId: "shia-kids-learning-tool",
            storageBucket: "shia-kids-learning-tool.appspot.com",
            messagingSenderId: "786313108719",
            appId: "1:786313108719:web:5d4d9ced7abd14b9d18f1a"
        };

        // Initialize Firebase
        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        if (!app) {
            console.error('Firebase initialization failed');
            alert('Failed to connect to the app. Please try again later.');
        }
        const auth = getAuth(app);

        // Global variables
        let userData = { name: '', gender: 'boy', year: 'Level-1', character: '', stars: 0, progress: 0, badges: ['Explorer'], quiz: {}, artwork: {}, storyPath: [] };
        let isAdmin = false;
        let selectedQuizCategory = null;

        // Quiz questions stored in localStorage
        let quizQuestions = JSON.parse(localStorage.getItem('quizQuestions')) || {
            'Level-1': [
                { id: 'q1', type: 'text', question: 'What is the name of the creator of the universe?', answer: 'Allah', category: 'Islamic Beliefs' },
                { id: 'q2', type: 'text', question: 'What is the name of the book that was revealed to Prophet Muhammad(s)?', answer: 'Quran', category: 'Quran' },
                { id: 'q3', type: 'multiple', question: 'Which Prophet was stuck in the belly of the whale?', options: ['Yusuf', 'Yunus', 'Ibrahim'], answer: 'Yunus', category: 'Islamic Personalities' }
            ],
            'Level-2': [], 'Level-3': [], 'Level-4': [], 'Level-5': [], 'Level-6': [], 'Level-7': []
        };

        function saveQuizQuestions() {
            localStorage.setItem('quizQuestions', JSON.stringify(quizQuestions));
        }

        // Define functions globally within the module
        window.showLoginModal = function() {
            console.log('Attempting to show login modal...');
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Login modal displayed');
            } else {
                console.error('Login modal element not found');
            }
        };

        window.showSignupModal = function() {
            console.log('Attempting to show signup modal...');
            const modal = document.getElementById('signup-modal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Signup modal displayed');
            } else {
                console.error('Signup modal element not found');
            }
        };

        window.showAdminLoginModal = function() {
            console.log('Attempting to show admin login modal...');
            const modal = document.getElementById('admin-login-modal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Admin login modal displayed');
            } else {
                console.error('Admin login modal element not found');
            }
        };

        window.showSection = function(sectionId) {
            document.querySelectorAll('.section, #landing-page, #hero').forEach(el => {
                if (el) el.classList.add('hidden');
            });
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('hidden');
                gsap.from(`#${sectionId.replace(/ /g, '-')}`, { opacity: 0, y: 50, duration: 0.5, ease: 'power2.out' });
                if (sectionId === 'profile' && !isAdmin) showProfile();
                if (sectionId === 'matching-game' && !isAdmin) initMatchingGame();
                if (sectionId === 'quiz') showQuiz();
                if (sectionId === 'wudhu-challenge' && !isAdmin) initWudhuChallenge();
                if (sectionId === 'admin-quiz' && isAdmin) showAdminQuiz();
                updateProgress();
                updateBadges();
            } else {
                console.error(`Section ${sectionId} not found`);
            }
        };

        window.signupUser = function() {
            userData.name = document.getElementById('signup-name')?.value || 'Young Explorer';
            userData.gender = document.querySelector('input[name="gender"]:checked')?.value || 'boy';
            userData.year = document.getElementById('year-select')?.value || 'Level-1';
            const selected = document.querySelector('.character.selected');
            userData.character = selected ? selected.src : document.querySelector('.character')?.src || 'https://yourusername.github.io/your-repo/images/mascot.png';
            saveUserData();

            const email = document.getElementById('signup-email')?.value;
            const password = document.getElementById('signup-password')?.value;
            if (!email || !password) {
                alert('‚ùå Please enter email and password');
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    alert("‚úÖ Sign-up successful!");
                    userData.email = email;
                    isAdmin = email === 'melzein1987@gmail.com';
                    const signupModal = document.getElementById('signup-modal');
                    if (signupModal) signupModal.style.display = 'none';
                    loadUserData();
                    showSection('welcome');
                })
                .catch(error => alert("‚ùå " + error.message));
        };

        window.login = function() {
            const email = document.getElementById('login-email')?.value;
            const password = document.getElementById('login-password')?.value;
            if (!email || !password) {
                alert('‚ùå Please enter email and password');
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    alert("‚úÖ Login successful!");
                    userData.email = email;
                    isAdmin = email === 'melzein1987@gmail.com';
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) loginModal.style.display = 'none';
                    loadUserData();
                    showSection('welcome');
                })
                .catch(error => alert("‚ùå " + error.message));
        };

        window.loginAdmin = function() {
            const email = document.getElementById('admin-username')?.value;
            const password = document.getElementById('admin-password')?.value;
            if (!email || !password) {
                alert('‚ùå Please enter email and password');
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    alert("‚úÖ Admin login successful!");
                    userData.email = email;
                    isAdmin = email === 'melzein1987@gmail.com';
                    const adminModal = document.getElementById('admin-login-modal');
                    if (adminModal) adminModal.style.display = 'none';
                    loadUserData();
                    showSection('welcome');
                })
                .catch(error => alert("‚ùå " + error.message));
        };

        window.resetPassword = function() {
            const email = document.getElementById('reset-email')?.value;
            if (!email) {
                alert('‚ùå Please enter an email');
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => alert("üìß Password reset email sent!"))
                .catch(error => alert("‚ùå " + error.message));
        };

        window.logout = function() {
            signOut(auth).then(() => {
                alert("‚úÖ Logged out successfully!");
                userData = { name: '', gender: 'boy', year: 'Level-1', character: '', stars: 0, progress: 0, badges: ['Explorer'], quiz: {}, artwork: {}, storyPath: [] };
                isAdmin = false;
                selectedQuizCategory = null;
                localStorage.removeItem('userData');
                const sections = ['landing-page', 'welcome', 'profile', 'avatar-display', 'matching-game', 'quiz', 'wudhu-challenge', 'admin-quiz'];
                sections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                const avatar = document.getElementById('avatar-display');
                if (avatar) avatar.style.display = 'none';
                document.getElementById('star-count').textContent = '0 ‚≠ê';
                document.getElementById('hero').classList.remove('hidden');
            }).catch(error => alert("‚ùå " + error.message));
        };

        function loadUserData() {
            const saved = localStorage.getItem('userData');
            if (saved) {
                userData = JSON.parse(saved);
                if (!userData.badges) userData.badges = ['Explorer'];
                if (!userData.quiz) userData.quiz = {};
                const avatar = document.getElementById('avatar-display');
                if (avatar) {
                    avatar.src = userData.character || 'https://yourusername.github.io/your-repo/images/mascot.png';
                    avatar.style.display = 'block';
                }
                const welcomeName = document.getElementById('welcome-name');
                if (welcomeName) welcomeName.textContent = userData.name || 'Young Explorer';
                updateStarCounter();
                updateProgress();
                updateBadges();
                const landingPage = document.getElementById('landing-page');
                const welcome = document.getElementById('welcome');
                const profile = document.getElementById('profile');
                if (landingPage) landingPage.classList.add('hidden');
                if (welcome) welcome.classList.remove('hidden');
                if (profile) profile.classList.add('hidden');
                showSection('welcome');
                updateWelcomeCardGrid();
            } else {
                const hero = document.getElementById('hero');
                const welcome = document.getElementById('welcome');
                const profile = document.getElementById('profile');
                if (hero) hero.classList.remove('hidden');
                if (welcome) welcome.classList.add('hidden');
                if (profile) profile.classList.add('hidden');
            }
        }

        function saveUserData() {
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        document.querySelectorAll('.character').forEach(img => {
            img.addEventListener('click', () => {
                document.querySelectorAll('.character').forEach(i => i.classList.remove('selected'));
                img.classList.add('selected');
                userData.character = img.src;
                const avatar = document.getElementById('avatar-display');
                if (avatar) avatar.src = userData.character;
                saveUserData();
            });
        });

        window.closeModal = function(event) {
            if (!event || !event.target) return;
            const className = event.target.className || '';
            if (className.includes('modal') || className.includes('btn')) {
                const modal = event.target.closest('.modal');
                if (modal && modal.id) {
                    document.getElementById(modal.id).style.display = 'none';
                }
                if (!userData.email) {
                    const hero = document.getElementById('hero');
                    const welcome = document.getElementById('welcome');
                    const profile = document.getElementById('profile');
                    if (hero) hero.classList.remove('hidden');
                    if (welcome) welcome.classList.add('hidden');
                    if (profile) profile.classList.add('hidden');
                }
                console.log('Modal closed via backdrop or button');
            }
        };

        function showProfile() {
            if (!userData.email) {
                alert("Please log in to view your profile!");
                showSection('welcome');
                return;
            }
            const container = document.getElementById('profile');
            if (!container) return;
            container.innerHTML = '';
            const content = document.createElement('div');
            content.className = 'content';
            content.innerHTML = `<h2 class="text-3xl text-orange-600 mb-4">Profile üè°</h2>
                <p>Email: ${userData.email || 'Not set'}</p>
                <p>Name: ${userData.name}</p>
                <div class="mt-2">
                    <label for="profile-year-select" class="block text-lg">Level:</label>
                    <select id="profile-year-select" class="border rounded-lg p-2 bg-white text-black mt-2 w-full">
                        ${['Level-1', 'Level-2', 'Level-3', 'Level-4', 'Level-5', 'Level-6', 'Level-7'].map(level => `<option value="${level}" ${userData.year === level ? 'selected' : ''}>${level}</option>`).join('')}
                    </select>
                    <button class="btn mt-2" onclick="updateUserLevel()">Update Level üîÑ</button>
                </div>
                <p>Stars: <span id="profile-star-count">${userData.stars}</span> ‚≠ê</p>
                <p>Progress: <span id="profile-progress">${userData.progress}/10</span></p>
                <p>Badges: ${userData.badges.join(', ')}</p>
                <img src="${userData.character || 'https://yourusername.github.io/your-repo/images/mascot.png'}" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mt-4">
                <button class="btn mt-4" onclick="showSection('welcome')">Back to Home üè°</button>
                <button class="btn mt-2" onclick="logout()">Logout üö™</button>`;
            container.appendChild(content);
            updateStarCounter();
            updateProgress();
        }

        window.updateUserLevel = function() {
            const newLevel = document.getElementById('profile-year-select')?.value;
            if (newLevel && newLevel !== userData.year) {
                userData.year = newLevel;
                saveUserData();
                alert(`Level updated to ${newLevel}!`);
                showProfile();
            }
        };

        function updateStarCounter() {
            const starCount = document.getElementById('star-count');
            if (starCount) starCount.textContent = `${userData.stars} ‚≠ê`;
            const profileStarCount = document.getElementById('profile-star-count');
            if (profileStarCount) profileStarCount.textContent = userData.stars;
            saveUserData();
        }

        function updateProgress() {
            const progressElement = document.getElementById('progress');
            if (progressElement) {
                const progress = (userData.progress / 10) * 100;
                progressElement.style.width = `${progress}%`;
            }
            const profileProgress = document.getElementById('profile-progress');
            if (profileProgress) profileProgress.textContent = `${userData.progress}/10`;
            saveUserData();
        }

        function updateBadges() {
            const badgeElement = document.querySelector('.badge');
            if (badgeElement) badgeElement.textContent = `üèÖ Badge: ${userData.badges[userData.badges.length - 1] || 'Explorer'}`;
            saveUserData();
        }

        function confetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // Matching Game Logic
        const individuals = [
            'Prophet Muhammad(s)', 'Imam Ali(as)', 'Sayeda Fatimah Al Zahraa(as)', 'Imam Al Hasan(as)',
            'Imam Al Hussain(as)', 'Imam Al Sajjad(as)', 'Imam Al Baqir(as)', 'Imam Al Sadiq(as)',
            'Imam Al Kathim(as)', 'Imam Al Redha(as)', 'Imam Al Jawad(as)', 'Imam Al Hadi(as)',
            'Imam Al Askari(as)', 'Imam Al Mahdi(as)'
        ];

        let flippedCards = [];
        let matchedPairs = 0;
        let canFlip = true;

        function initMatchingGame() {
            const container = document.getElementById('matching-game');
            if (!container) return;
            container.innerHTML = '';
            const content = document.createElement('div');
            content.className = 'content';
            content.innerHTML = `
                <h2 class="text-3xl text-orange-600 mb-4">Matching Game üß†</h2>
                <p>Match the names of the holy individuals!</p>
                <div id="game-grid" class="game-grid"></div>
                <p id="game-feedback" class="mt-4"></p>
                <button class="btn mt-4" onclick="resetMatchingGame()">Reset Game üîÑ</button>
                <button class="btn mt-4" onclick="showSection('welcome')">Back to Home üè°</button>
                <button class="btn mt-2" onclick="logout()">Logout üö™</button>
            `;
            container.appendChild(content);

            const gameGrid = document.getElementById('game-grid');
            const cards = [...individuals, ...individuals];
            cards.sort(() => Math.random() - 0.5);

            gameGrid.innerHTML = '';
            cards.forEach((name, index) => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.dataset.name = name;
                card.innerHTML = `
                    <div class="card-front">?</div>
                    <div class="card-back">${name}</div>
                `;
                card.addEventListener('click', () => flipCard(card));
                gameGrid.appendChild(card);
            });

            flippedCards = [];
            matchedPairs = 0;
            canFlip = true;
            document.getElementById('game-feedback').textContent = '';
            console.log('Matching game initialized');
        }

        function flipCard(card) {
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                console.log('Card flip blocked: canFlip=', canFlip, 'flipped=', card.classList.contains('flipped'), 'matched=', card.classList.contains('matched'));
                return;
            }

            console.log('Flipping card:', card.dataset.name);
            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                canFlip = false;
                const [card1, card2] = flippedCards;
                console.log('Comparing:', card1.dataset.name, 'and', card2.dataset.name);

                if (card1.dataset.name === card2.dataset.name) {
                    console.log('Match found!');
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    document.getElementById('game-feedback').textContent = 'Match found! Keep going!';
                    if (matchedPairs === individuals.length) {
                        userData.stars += 14;
                        userData.progress = Math.min(userData.progress + 1, 10);
                        updateStarCounter();
                        updateProgress();
                        confetti();
                        document.getElementById('game-feedback').innerHTML = '<span class="text-green-600 text-xl">Congratulations! All pairs matched! +14 Stars! üéâ</span>';
                        console.log('Game completed! Stars awarded:', userData.stars);
                    }
                    flippedCards = [];
                    canFlip = true;
                    console.log('Flipping enabled after match, matchedPairs:', matchedPairs);
                } else {
                    console.log('No match.');
                    document.getElementById('game-feedback').textContent = 'No match. Try again!';
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                        canFlip = true;
                        console.log('Flipping enabled after non-match');
                    }, 1000);
                }
            } else {
                console.log('Waiting for second card, flippedCards:', flippedCards.length);
            }
        }

        window.resetMatchingGame = function() {
            initMatchingGame();
            console.log('Game reset');
        };

        // Wudhu Challenge Logic
        const wudhuActs = [
            { name: 'Rinse mouth', type: 'Mustahab', order: 1 },
            { name: 'Rinse nose', type: 'Mustahab', order: 2 },
            { name: 'Wash hands', type: 'Mustahab', order: 3 },
            { name: 'Niyyah (Intention)', type: 'Obligatory', order: 4 },
            { name: 'Wash Face', type: 'Obligatory', order: 5 },
            { name: 'Wash Right Arm', type: 'Obligatory', order: 6 },
            { name: 'Wash Left Arm', type: 'Obligatory', order: 7 },
            { name: 'Wipe Head', type: 'Obligatory', order: 8 },
            { name: 'Wipe Right Foot', type: 'Obligatory', order: 9 },
            { name: 'Wipe Left Foot', type: 'Obligatory', order: 10 }
        ];

        function initWudhuChallenge() {
            if (!userData.email) {
                alert("Please log in to play the Wudhu Challenge!");
                showSection('welcome');
                return;
            }
            const container = document.getElementById('wudhu-challenge');
            if (!container) return;
            container.innerHTML = '';
            const content = document.createElement('div');
            content.className = 'content';
            content.innerHTML = `
                <h2 class="text-3xl text-orange-600 mb-4">Wudhu Challenge üíß</h2>
                <p>Drag the Wudhu steps into the correct order and choose if each is Obligatory or Mustahab!</p>
                <div id="wudhu-grid" class="wudhu-grid"></div>
                <p id="wudhu-feedback" class="mt-4"></p>
                <button class="btn mt-4" onclick="checkWudhuOrder()">Submit üéâ</button>
                <button class="btn mt-4" onclick="initWudhuChallenge()">Reset Game üîÑ</button>
                <button class="btn mt-4" onclick="showSection('welcome')">Back to Home üè°</button>
                <button class="btn mt-2" onclick="logout()">Logout üö™</button>
            `;
            container.appendChild(content);

            const wudhuGrid = document.getElementById('wudhu-grid');
            const shuffledActs = [...wudhuActs].sort(() => Math.random() - 0.5);
            wudhuGrid.innerHTML = '';
            shuffledActs.forEach((act, index) => {
                const actDiv = document.createElement('div');
                actDiv.className = 'wudhu-act';
                actDiv.draggable = true;
                actDiv.dataset.name = act.name;
                actDiv.innerHTML = `
                    <div class="wudhu-act-content">
                        <span class="wudhu-act-number">${index + 1}</span>
                        <span>${act.name}</span>
                        <select class="wudhu-type-select border rounded-lg p-1 bg-white text-black ml-2">
                            <option value="">Select Type</option>
                            <option value="Obligatory">Obligatory</option>
                            <option value="Mustahab">Mustahab</option>
                        </select>
                    </div>
                `;
                wudhuGrid.appendChild(actDiv);
            });

            // Drag and Drop functionality
            const acts = document.querySelectorAll('.wudhu-act');
            acts.forEach(act => {
                act.addEventListener('dragstart', dragStart);
                act.addEventListener('dragover', dragOver);
                act.addEventListener('drop', drop);
            });

            function dragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.dataset.name);
            }

            function dragOver(e) {
                e.preventDefault();
            }

            function drop(e) {
                e.preventDefault();
                const draggedName = e.dataTransfer.getData('text/plain');
                const draggedAct = Array.from(acts).find(act => act.dataset.name === draggedName);
                const targetAct = e.target.closest('.wudhu-act');
                if (draggedAct && targetAct && draggedAct !== targetAct) {
                    const draggedIndex = Array.from(wudhuGrid.children).indexOf(draggedAct);
                    const targetIndex = Array.from(wudhuGrid.children).indexOf(targetAct);
                    if (draggedIndex < targetIndex) {
                        wudhuGrid.insertBefore(draggedAct, targetAct.nextSibling);
                    } else {
                        wudhuGrid.insertBefore(draggedAct, targetAct);
                    }
                    updateActNumbers();
                }
            }

            function updateActNumbers() {
                document.querySelectorAll('.wudhu-act-number').forEach((num, index) => {
                    num.textContent = index + 1;
                });
            }

            console.log('Wudhu Challenge initialized');
        }

        window.checkWudhuOrder = function() {
            const wudhuGrid = document.getElementById('wudhu-grid');
            const feedback = document.getElementById('wudhu-feedback');
            if (!wudhuGrid || !feedback) return;

            const acts = Array.from(wudhuGrid.children);
            let correct = true;
            acts.forEach((act, index) => {
                const actName = act.dataset.name;
                const selectedType = act.querySelector('.wudhu-type-select').value;
                const correctAct = wudhuActs[index];
                if (actName !== correctAct.name || selectedType !== correctAct.type) {
                    correct = false;
                }
            });

            if (correct) {
                userData.stars += 10;
                userData.progress = Math.min(userData.progress + 1, 10);
                updateStarCounter();
                updateProgress();
                confetti();
                feedback.className = 'text-green-600 mt-2';
                feedback.textContent = 'Correct! +10 Stars! üéâ';
            } else {
                feedback.className = 'text-red-600 mt-2';
                feedback.textContent = 'Wrong order or type! Try again! üòï';
            }
        };

        // Quiz Logic
        let currentQuestionIndex = 0;
        let quizCompleted = false;

        function showQuiz() {
            if (!userData.email) {
                alert("Please log in to take the quiz!");
                showSection('welcome');
                return;
            }
            const container = document.getElementById('quiz');
            if (!container) return;
            container.innerHTML = '';
            const content = document.createElement('div');
            content.className = 'content';
            content.innerHTML = `
                <h2 class="text-3xl text-orange-600 mb-4">Quiz Time üìö</h2>
                <div id="quiz-content" class="story-card mb-4">
                    <h3 class="text-xl">Select a Category</h3>
                    <select id="quiz-category-select" class="border rounded-lg p-2 bg-white text-black mt-2 w-full">
                        <option value="">Select a category</option>
                        <option value="Islamic Laws">Islamic Laws</option>
                        <option value="Islamic Beliefs">Islamic Beliefs</option>
                        <option value="Quran">Quran</option>
                        <option value="Islamic Personalities">Islamic Personalities</option>
                        <option value="Islamic History">Islamic History</option>
                    </select>
                    <button class="btn mt-2" onclick="startQuiz()">Start Quiz üéâ</button>
                </div>
                <p id="quiz-feedback" class="mt-4"></p>
                <button class="btn mt-4" onclick="showSection('welcome')">Back to Home üè°</button>
                <button class="btn mt-2" onclick="logout()">Logout üö™</button>`;
            container.appendChild(content);
        }

        window.startQuiz = function() {
            const categorySelect = document.getElementById('quiz-category-select');
            if (!categorySelect) return;
            selectedQuizCategory = categorySelect.value;
            if (!selectedQuizCategory) {
                alert('Please select a quiz category!');
                return;
            }
            currentQuestionIndex = 0;
            quizCompleted = userData.quiz[userData.year]?.[selectedQuizCategory]?.completed || false;
            showQuizQuestion();
        };

        function showQuizQuestion() {
            const quizContent = document.getElementById('quiz-content');
            const feedback = document.getElementById('quiz-feedback');
            if (!quizContent || !feedback) return;
            feedback.textContent = '';
            const questions = (quizQuestions[userData.year] || []).filter(q => q.category === selectedQuizCategory);

            if (questions.length === 0) {
                quizContent.innerHTML = `
                    <h3 class="text-xl">No Questions Available</h3>
                    <p>No questions found for ${selectedQuizCategory} in ${userData.year}. Try another category!</p>
                    <button class="btn mt-2" onclick="showQuiz()">Change Category üîÑ</button>
                `;
                return;
            }

            if (quizCompleted) {
                quizContent.innerHTML = `
                    <h3 class="text-xl">Quiz Completed!</h3>
                    <p>You've already completed the ${selectedQuizCategory} quiz for ${userData.year}. Try another category!</p>
                    <button class="btn mt-2" onclick="showQuiz()">Change Category üîÑ</button>
                `;
                return;
            }

            if (currentQuestionIndex >= questions.length) {
                quizCompleted = true;
                userData.quiz[userData.year] = userData.quiz[userData.year] || {};
                userData.quiz[userData.year][selectedQuizCategory] = userData.quiz[userData.year][selectedQuizCategory] || {};
                userData.quiz[userData.year][selectedQuizCategory].completed = true;
                userData.progress = Math.min(userData.progress + 1, 10);
                updateProgress();
                saveUserData();
                confetti();
                quizContent.innerHTML = `
                    <h3 class="text-xl">Congratulations!</h3>
                    <p class="text-green-600 text-xl">You've completed the ${selectedQuizCategory} quiz for ${userData.year}! üéâ</p>
                    <button class="btn mt-2" onclick="showQuiz()">Change Category üîÑ</button>
                `;
                return;
            }

            const question = questions[currentQuestionIndex];
            quizContent.innerHTML = `
                <h3 class="text-xl">Question ${currentQuestionIndex + 1}</h3>
                <p>${question.question}</p>
                ${question.type === 'text' ? 
                    `<input id="quiz-answer-${question.id}" class="border rounded-lg p-2 bg-white text-black mt-2 w-full" placeholder="Type your answer">` :
                    `<div class="mt-2">${question.options.map(option => `
                        <label class="block"><input type="radio" name="quiz-${question.id}" value="${option}" class="mr-2">${option}</label>
                    `).join('')}</div>`}
                <button class="btn mt-2" onclick="checkQuizAnswer('${question.id}', '${question.answer}')">Submit üéâ</button>
                <button class="btn mt-2" onclick="showQuiz()">Change Category üîÑ</button>
            `;
        }

        window.checkQuizAnswer = function(id, correctAnswer) {
            const question = (quizQuestions[userData.year] || []).find(q => q.id === id);
            let userAnswer;
            if (question.type === 'text') {
                const input = document.getElementById(`quiz-answer-${id}`);
                if (!input) return;
                userAnswer = input.value.trim().toLowerCase();
            } else {
                const selected = document.querySelector(`input[name="quiz-${id}"]:checked`);
                userAnswer = selected ? selected.value.toLowerCase() : '';
            }

            const feedback = document.getElementById('quiz-feedback');
            if (!feedback) return;
            if (userAnswer === correctAnswer.toLowerCase()) {
                if (!userData.quiz[userData.year]?.[selectedQuizCategory]?.[id]) {
                    userData.stars += 2;
                    userData.quiz[userData.year] = userData.quiz[userData.year] || {};
                    userData.quiz[userData.year][selectedQuizCategory] = userData.quiz[userData.year][selectedQuizCategory] || {};
                    userData.quiz[userData.year][selectedQuizCategory][id] = true;
                    updateStarCounter();
                    saveUserData();
                }
                feedback.className = 'text-green-600 mt-2';
                feedback.textContent = 'Correct! +2 Stars! üéâ';
                setTimeout(() => {
                    currentQuestionIndex++;
                    showQuizQuestion();
                }, 1000);
            } else {
                feedback.className = 'text-red-600 mt-2';
                feedback.textContent = 'Wrong! Try again! üòï';
            }
        };

        // Admin Quiz Management
        let currentPage = 1;
        const questionsPerPage = 10;
        let amendingQuestion = null;

        function showAdminQuiz() {
            if (!isAdmin) {
                alert("Access denied. Admin login required!");
                showSection('welcome');
                return;
            }
            const container = document.getElementById('admin-quiz');
            if (!container) return;
            container.innerHTML = '';
            const content = document.createElement('div');
            content.className = 'content admin-content';
            content.innerHTML = `
                <h2 class="text-3xl text-orange-600 mb-4">Admin Quiz Management üîß</h2>
                <div class="story-card mb-4">
                    <h3 class="text-xl">${amendingQuestion ? 'Amend Question' : 'Add New Question'}</h3>
                    <input id="admin-question-text" class="border rounded-lg p-2 bg-white text-black mt-2 w-full" placeholder="Question text" value="${amendingQuestion ? amendingQuestion.question : ''}">
                    <select id="admin-question-type" class="border rounded-lg p-2 bg-white text-black mt-2 w-full" onchange="toggleAnswerFields()">
                        <option value="text" ${amendingQuestion && amendingQuestion.type === 'text' ? 'selected' : ''}>Free Text</option>
                        <option value="multiple" ${amendingQuestion && amendingQuestion.type === 'multiple' ? 'selected' : ''}>Multiple Choice</option>
                    </select>
                    <select id="admin-question-level" class="border rounded-lg p-2 bg-white text-black mt-2 w-full">
                        ${['Level-1', 'Level-2', 'Level-3', 'Level-4', 'Level-5', 'Level-6', 'Level-7'].map(level => `<option value="${level}" ${amendingQuestion && amendingQuestion.level === level ? 'selected' : ''}>${level}</option>`).join('')}
                    </select>
                    <select id="admin-question-category" class="border rounded-lg p-2 bg-white text-black mt-2 w-full">
                        <option value="">Select a category</option>
                        <option value="Islamic Laws" ${amendingQuestion && amendingQuestion.category === 'Islamic Laws' ? 'selected' : ''}>Islamic Laws</option>
                        <option value="Islamic Beliefs" ${amendingQuestion && amendingQuestion.category === 'Islamic Beliefs' ? 'selected' : ''}>Islamic Beliefs</option>
                        <option value="Quran" ${amendingQuestion && amendingQuestion.category === 'Quran' ? 'selected' : ''}>Quran</option>
                        <option value="Islamic Personalities" ${amendingQuestion && amendingQuestion.category === 'Islamic Personalities' ? 'selected' : ''}>Islamic Personalities</option>
                        <option value="Islamic History" ${amendingQuestion && amendingQuestion.category === 'Islamic History' ? 'selected' : ''}>Islamic History</option>
                    </select>
                    <div id="answer-fields" class="${amendingQuestion && amendingQuestion.type === 'multiple' ? 'hidden' : ''}">
                        <input id="admin-answer-text" class="border rounded-lg p-2 bg-white text-black mt-2 w-full" placeholder="Correct answer" value="${amendingQuestion && amendingQuestion.type === 'text' ? amendingQuestion.answer : ''}">
                    </div>
                    <div id="multiple-choice-fields" class="${amendingQuestion && amendingQuestion.type === 'text' ? 'hidden' : ''}">
                        <div class="mt-2">
                            <input id="admin-option-1" class="border rounded-lg p-2 bg-white text-black w-3/4" placeholder="Option 1" value="${amendingQuestion && amendingQuestion.options ? amendingQuestion.options[0] || '' : ''}">
                            <label class="ml-2"><input type="checkbox" id="correct-option-1" ${amendingQuestion && amendingQuestion.options && amendingQuestion.answer === amendingQuestion.options[0] ? 'checked' : ''} onchange="ensureSingleCorrectAnswer(1)"> Correct</label>
                        </div>
                        <div class="mt-2">
                            <input id="admin-option-2" class="border rounded-lg p-2 bg-white text-black w-3/4" placeholder="Option 2" value="${amendingQuestion && amendingQuestion.options ? amendingQuestion.options[1] || '' : ''}">
                            <label class="ml-2"><input type="checkbox" id="correct-option-2" ${amendingQuestion && amendingQuestion.options && amendingQuestion.answer === amendingQuestion.options[1] ? 'checked' : ''} onchange="ensureSingleCorrectAnswer(2)"> Correct</label>
                        </div>
                        <div class="mt-2">
                            <input id="admin-option-3" class="border rounded-lg p-2 bg-white text-black w-3/4" placeholder="Option 3 (optional)" value="${amendingQuestion && amendingQuestion.options ? amendingQuestion.options[2] || '' : ''}">
                            <label class="ml-2"><input type="checkbox" id="correct-option-3" ${amendingQuestion && amendingQuestion.options && amendingQuestion.answer === amendingQuestion.options[2] ? 'checked' : ''} onchange="ensureSingleCorrectAnswer(3)"> Correct</label>
                        </div>
                        <div class="mt-2">
                            <input id="admin-option-4" class="border rounded-lg p-2 bg-white text-black w-3/4" placeholder="Option 4 (optional)" value="${amendingQuestion && amendingQuestion.options ? amendingQuestion.options[3] || '' : ''}">
                            <label class="ml-2"><input type="checkbox" id="correct-option-4" ${amendingQuestion && amendingQuestion.options && amendingQuestion.answer === amendingQuestion.options[3] ? 'checked' : ''} onchange="ensureSingleCorrectAnswer(4)"> Correct</label>
                        </div>
                    </div>
                    <button class="btn mt-2" onclick="${amendingQuestion ? `amendQuestion('${amendingQuestion.level}', '${amendingQuestion.id}')` : 'addQuestion()'}">${amendingQuestion ? 'Save Changes üíæ' : 'Add Question ‚ûï'}</button>
                    ${amendingQuestion ? '<button class="btn mt-2 bg-gray-500 hover:bg-gray-700" onclick="cancelAmend()">Cancel Amend ‚ùå</button>' : ''}
                </div>
                <div id="question-list" class="story-card mb-4">
                    <h3 class="text-xl">Existing Questions</h3>
                    <input id="question-search" class="border rounded-lg p-2 bg-white text-black mt-2 w-full" placeholder="Search questions...">
                    <div id="questions-display"></div>
                    <div class="pagination mt-4">
                        <button class="btn mr-2" onclick="changePage(-1)">Previous</button>
                        <span id="page-info"></span>
                        <button class="btn ml-2" onclick="changePage(1)">Next</button>
                    </div>
                </div>
                <button class="btn mt-4" onclick="showSection('welcome')">Back to Home üè°</button>
                <button class="btn mt-2" onclick="logout()">Logout üö™</button>
            `;
            container.appendChild(content);
            toggleAnswerFields();
            displayQuestions();
        }

        window.toggleAnswerFields = function() {
            const type = document.getElementById('admin-question-type')?.value;
            const answerFields = document.getElementById('answer-fields');
            const multipleChoiceFields = document.getElementById('multiple-choice-fields');
            if (answerFields) answerFields.classList.toggle('hidden', type === 'multiple');
            if (multipleChoiceFields) multipleChoiceFields.classList.toggle('hidden', type === 'text');
        };

        window.ensureSingleCorrectAnswer = function(index) {
            const checkboxes = [1, 2, 3, 4].map(i => document.getElementById(`correct-option-${i}`));
            checkboxes.forEach((cb, i) => {
                if (i + 1 !== index) cb.checked = false;
            });
        };

        window.addQuestion = function() {
            const questionText = document.getElementById('admin-question-text')?.value?.trim() || '';
            const level = document.getElementById('admin-question-level')?.value || '';
            const type = document.getElementById('admin-question-type')?.value || '';
            const category = document.getElementById('admin-question-category')?.value || '';
            let answer = '';
            let options = [];

            if (type === 'multiple') {
                options = [
                    document.getElementById('admin-option-1')?.value?.trim() || '',
                    document.getElementById('admin-option-2')?.value?.trim() || '',
                    document.getElementById('admin-option-3')?.value?.trim() || '',
                    document.getElementById('admin-option-4')?.value?.trim() || ''
                ].filter(opt => opt.length > 0);
                const correctCheckboxes = [1, 2, 3, 4].map(i => document.getElementById(`correct-option-${i}`)?.checked);
                const correctIndex = correctCheckboxes.findIndex(checked => checked);
                answer = correctIndex >= 0 ? options[correctIndex] : '';
            } else {
                answer = document.getElementById('admin-answer-text')?.value?.trim() || '';
            }

            console.log('Adding question:', { questionText, level, type, category, answer, options, optionCount: options.length });

            if (!questionText) {
                alert('Please fill in the question text.');
                console.log('Validation failed: Missing question text');
                return;
            }

            if (!level) {
                alert('Please select a level.');
                console.log('Validation failed: Missing level');
                return;
            }

            if (!type) {
                alert('Please select a question type.');
                console.log('Validation failed: Missing type');
                return;
            }

            if (!category) {
                alert('Please select a category.');
                console.log('Validation failed: Missing category');
                return;
            }

            if (!answer) {
                alert('Please provide a correct answer' + (type === 'multiple' ? ' by selecting one option.' : '.'));
                console.log('Validation failed: Missing answer');
                return;
            }

            if (type === 'multiple' && options.length < 2) {
                alert('Please provide at least 2 non-empty options for multiple choice.');
                console.log('Validation failed: Fewer than 2 options');
                return;
            }

            if (type === 'multiple' && !options.includes(answer)) {
                alert('The correct answer must be one of the multiple-choice options.');
                console.log('Validation failed: Answer not in options');
                return;
            }

            const id = `q${Date.now()}`;
            quizQuestions[level] = quizQuestions[level] || [];
            quizQuestions[level].push({
                id,
                type,
                question: questionText,
                answer,
                category,
                ...(type === 'multiple' && { options })
            });

            saveQuizQuestions();
            displayQuestions();
            alert('Question added successfully!');
            console.log('Question added:', { id, questionText, level, type, category, answer, options });
            document.getElementById('admin-question-text').value = '';
            document.getElementById('admin-question-category').value = '';
            if (type === 'text') {
                document.getElementById('admin-answer-text').value = '';
            } else {
                [1, 2, 3, 4].forEach(i => {
                    document.getElementById(`admin-option-${i}`).value = '';
                    document.getElementById(`correct-option-${i}`).checked = false;
                });
            }
        };

        window.amendQuestion = function(level, id) {
            const questionText = document.getElementById('admin-question-text')?.value?.trim() || '';
            const newLevel = document.getElementById('admin-question-level')?.value || '';
            const type = document.getElementById('admin-question-type')?.value || '';
            const category = document.getElementById('admin-question-category')?.value || '';
            let answer = '';
            let options = [];

            if (type === 'multiple') {
                options = [
                    document.getElementById('admin-option-1')?.value?.trim() || '',
                    document.getElementById('admin-option-2')?.value?.trim() || '',
                    document.getElementById('admin-option-3')?.value?.trim() || '',
                    document.getElementById('admin-option-4')?.value?.trim() || ''
                ].filter(opt => opt.length > 0);
                const correctCheckboxes = [1, 2, 3, 4].map(i => document.getElementById(`correct-option-${i}`)?.checked);
                const correctIndex = correctCheckboxes.findIndex(checked => checked);
                answer = correctIndex >= 0 ? options[correctIndex] : '';
            } else {
                answer = document.getElementById('admin-answer-text')?.value?.trim() || '';
            }

            if (!questionText) {
                alert('Please fill in the question text.');
                return;
            }

            if (!newLevel) {
                alert('Please select a level.');
                return;
            }

            if (!type) {
                alert('Please select a question type.');
                return;
            }

            if (!category) {
                alert('Please select a category.');
                return;
            }

            if (!answer) {
                alert('Please provide a correct answer' + (type === 'multiple' ? ' by selecting one option.' : '.'));
                return;
            }

            if (type === 'multiple' && options.length < 2) {
                alert('Please provide at least 2 non-empty options for multiple choice.');
                return;
            }

            if (type === 'multiple' && !options.includes(answer)) {
                alert('The correct answer must be one of the multiple-choice options.');
                return;
            }

            // Remove from old level if level changed
            if (level !== newLevel) {
                quizQuestions[level] = quizQuestions[level].filter(q => q.id !== id);
            }

            // Update or add to new level
            quizQuestions[newLevel] = quizQuestions[newLevel] || [];
            const questionIndex = quizQuestions[newLevel].findIndex(q => q.id === id);
            const updatedQuestion = {
                id,
                type,
                question: questionText,
                answer,
                category,
                level: newLevel,
                ...(type === 'multiple' && { options })
            };

            if (questionIndex >= 0) {
                quizQuestions[newLevel][questionIndex] = updatedQuestion;
            } else {
                quizQuestions[newLevel].push(updatedQuestion);
            }

            // Update user quiz data if necessary
            if (level !== newLevel) {
                Object.keys(userData.quiz).forEach(lvl => {
                    Object.keys(userData.quiz[lvl] || {}).forEach(cat => {
                        if (userData.quiz[lvl][cat]?.[id]) {
                            delete userData.quiz[lvl][cat][id];
                            if (Object.keys(userData.quiz[lvl][cat]).length === 1 && userData.quiz[lvl][cat].completed) {
                                delete userData.quiz[lvl][cat].completed;
                            }
                        }
                    });
                });
            }

            saveQuizQuestions();
            saveUserData();
            amendingQuestion = null;
            displayQuestions();
            showAdminQuiz();
            alert('Question amended successfully!');
        };

        window.cancelAmend = function() {
            amendingQuestion = null;
            showAdminQuiz();
        };

        window.startAmendQuestion = function(level, id) {
            const question = quizQuestions[level].find(q => q.id === id);
            if (question) {
                amendingQuestion = { ...question, level };
                showAdminQuiz();
            }
        };

        window.removeQuestion = function(level, id) {
            quizQuestions[level] = quizQuestions[level].filter(q => q.id !== id);
            Object.keys(userData.quiz).forEach(lvl => {
                Object.keys(userData.quiz[lvl] || {}).forEach(cat => {
                    if (userData.quiz[lvl][cat]?.[id]) {
                        delete userData.quiz[lvl][cat][id];
                        if (Object.keys(userData.quiz[lvl][cat]).length === 1 && userData.quiz[lvl][cat].completed) {
                            delete userData.quiz[lvl][cat].completed;
                        }
                    }
                });
            });
            saveQuizQuestions();
            saveUserData();
            displayQuestions();
            alert('Question removed successfully!');
        };

        function displayQuestions() {
            const display = document.getElementById('questions-display');
            const pageInfo = document.getElementById('page-info');
            const searchInput = document.getElementById('question-search');
            if (!display || !pageInfo) return;

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filteredQuestions = {};
            Object.keys(quizQuestions).forEach(level => {
                filteredQuestions[level] = quizQuestions[level].filter(q => 
                    q.question.toLowerCase().includes(searchTerm) || 
                    q.answer.toLowerCase().includes(searchTerm) ||
                    (q.options && q.options.some(opt => opt.toLowerCase().includes(searchTerm))) ||
                    q.category.toLowerCase().includes(searchTerm)
                );
            });

            display.innerHTML = '';
            let totalQuestions = 0;
            Object.values(filteredQuestions).forEach(levelQuestions => {
                totalQuestions += levelQuestions.length;
            });
            const totalPages = Math.ceil(totalQuestions / questionsPerPage);
            currentPage = Math.min(currentPage, Math.max(1, totalPages));

            let startIndex = (currentPage - 1) * questionsPerPage;
            let currentIndex = 0;
            let renderedQuestions = 0;

            Object.keys(filteredQuestions).forEach(level => {
                if (renderedQuestions >= questionsPerPage) return;
                const levelQuestions = filteredQuestions[level];
                if (levelQuestions.length === 0) return;

                const levelDiv = document.createElement('div');
                levelDiv.className = 'level-section';
                levelDiv.innerHTML = `
                    <h4 class="text-lg mt-4 cursor-pointer flex justify-between items-center" onclick="toggleLevelSection(this)">
                        ${level} <span>‚ñº</span>
                    </h4>
                    <div class="level-questions"></div>
                `;
                const questionsContainer = levelDiv.querySelector('.level-questions');

                levelQuestions.forEach((q, index) => {
                    if (currentIndex >= startIndex && renderedQuestions < questionsPerPage) {
                        const qDiv = document.createElement('div');
                        qDiv.className = 'border-b py-2';
                        qDiv.innerHTML = `
                            <p><strong>Question:</strong> ${q.question}</p>
                            <p><strong>Type:</strong> ${q.type === 'text' ? 'Free Text' : 'Multiple Choice'}</p>
                            <p><strong>Category:</strong> ${q.category}</p>
                            <p><strong>Answer:</strong> ${q.answer}</p>
                            ${q.options ? `<p><strong>Options:</strong> ${q.options.join(', ')}</p>` : ''}
                            <button class="btn mt-2 bg-blue-500 hover:bg-blue-700" onclick="startAmendQuestion('${level}', '${q.id}')">Amend ‚úèÔ∏è</button>
                            <button class="btn mt-2 bg-red-500 hover:bg-red-700" onclick="removeQuestion('${level}', '${q.id}')">Remove üóëÔ∏è</button>
                        `;
                        questionsContainer.appendChild(qDiv);
                        renderedQuestions++;
                    }
                    currentIndex++;
                });

                if (questionsContainer.children.length > 0) {
                    display.appendChild(levelDiv);
                }
            });

            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.querySelector('.pagination button:first-child').disabled = currentPage === 1;
            document.querySelector('.pagination button:last-child').disabled = currentPage === totalPages;
        }

        window.changePage = function(delta) {
            currentPage += delta;
            displayQuestions();
        };

        window.toggleLevelSection = function(header) {
            const questionsDiv = header.nextElementSibling;
            questionsDiv.classList.toggle('hidden');
            const toggleIcon = header.querySelector('span');
            toggleIcon.textContent = questionsDiv.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        };

        function updateWelcomeCardGrid() {
            const cardGrid = document.getElementById('welcome-card-grid');
            if (!cardGrid) return;
            cardGrid.innerHTML = ''; // Clear existing cards
            if (isAdmin) {
                // Only show Admin Quiz Management for admins
                const adminCard = document.createElement('div');
                adminCard.className = 'card';
                adminCard.onclick = () => showSection('admin-quiz');
                adminCard.innerHTML = `
                    <h3>Admin Quiz Management</h3>
                    <p>Manage Quiz Questions üîß</p>
                `;
                cardGrid.appendChild(adminCard);
            } else {
                // Show all cards except Admin Quiz Management for non-admins
                const cards = [
                    { id: 'profile', title: 'Profile', desc: 'Your Journey üè°' },
                    { id: 'matching-game', title: 'Matching Game', desc: 'Match Holy Individuals üß†' },
                    { id: 'quiz', title: 'Quiz', desc: 'Test Your Knowledge üìö' },
                    { id: 'wudhu-challenge', title: 'Wudhu Challenge', desc: 'Learn Wudhu Steps üíß' }
                ];
                cards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.onclick = () => showSection(card.id);
                    cardElement.innerHTML = `
                        <h3>${card.title}</h3>
                        <p>${card.desc}</p>
                    `;
                    cardGrid.appendChild(cardElement);
                });
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing app...');

            const hero = document.getElementById('hero');
            const welcome = document.getElementById('welcome');
            const profile = document.getElementById('profile');
            const matchingGame = document.getElementById('matching-game');
            const quiz = document.getElementById('quiz');
            const wudhuChallenge = document.getElementById('wudhu-challenge');
            const adminQuiz = document.getElementById('admin-quiz');
            if (hero) hero.classList.remove('hidden');
            if (welcome) welcome.classList.add('hidden');
            if (profile) profile.classList.add('hidden');
            if (matchingGame) matchingGame.classList.add('hidden');
            if (quiz) quiz.classList.add('hidden');
            if (wudhuChallenge) wudhuChallenge.classList.add('hidden');
            if (adminQuiz) adminQuiz.classList.add('hidden');

            ['login-modal', 'signup-modal', 'admin-login-modal', 'reset-password-modal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal) modal.style.display = 'none';
            });

            let authInitialized = false;
            const initAuth = () => {
                if (authInitialized) return;
                authInitialized = true;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userData.email = user.email;
                        isAdmin = user.email === 'melzein1987@gmail.com';
                        loadUserData();
                        const loginModal = document.getElementById('login-modal');
                        const hero = document.getElementById('hero');
                        const welcome = document.getElementById('welcome');
                        if (loginModal) loginModal.style.display = 'none';
                        if (hero) hero.classList.add('hidden');
                        if (welcome) welcome.classList.remove('hidden');
                        showSection('welcome');
                    } else {
                        userData = { name: '', gender: 'boy', year: 'Level-1', character: '', stars: 0, progress: 0, badges: ['Explorer'], quiz: {}, artwork: {}, storyPath: [] };
                        isAdmin = false;
                        selectedQuizCategory = null;
                        localStorage.removeItem('userData');
                        const hero = document.getElementById('hero');
                        const welcome = document.getElementById('welcome');
                        const profile = document.getElementById('profile');
                        const matchingGame = document.getElementById('matching-game');
                        const quiz = document.getElementById('quiz');
                        const wudhuChallenge = document.getElementById('wudhu-challenge');
                        const adminQuiz = document.getElementById('admin-quiz');
                        if (hero) hero.classList.remove('hidden');
                        if (welcome) welcome.classList.add('hidden');
                        if (profile) profile.classList.add('hidden');
                        if (matchingGame) matchingGame.classList.add('hidden');
                        if (quiz) quiz.classList.add('hidden');
                        if (wudhuChallenge) wudhuChallenge.classList.add('hidden');
                        if (adminQuiz) adminQuiz.classList.add('hidden');
                        ['login-modal', 'signup-modal', 'admin-login-modal', 'reset-password-modal'].forEach(id => {
                            const modal = document.getElementById(id);
                            if (modal) modal.style.display = 'none';
                        });
                    }
                }, (error) => {
                    console.error('Auth error:', error.message);
                    alert('Authentication failed. Please try again or contact support.');
                    const hero = document.getElementById('hero');
                    if (hero) hero.classList.remove('hidden');
                });
            };

            initAuth();

            console.log('Functions defined:', {
                showLoginModal: typeof window.showLoginModal,
                showSignupModal: typeof window.showSignupModal,
                showAdminLoginModal: typeof window.showAdminLoginModal
            });

            window.addEventListener('load', () => {
                console.log('Window fully loaded, verifying UI...');
                const hero = document.getElementById('hero');
                const welcome = document.getElementById('welcome');
                const profile = document.getElementById('profile');
                const matchingGame = document.getElementById('matching-game');
                const quiz = document.getElementById('quiz');
                const wudhuChallenge = document.getElementById('wudhu-challenge');
                const adminQuiz = document.getElementById('admin-quiz');
                if (hero) hero.classList.remove('hidden');
                if (welcome) welcome.classList.add('hidden');
                if (profile) profile.classList.add('hidden');
                if (matchingGame) matchingGame.classList.add('hidden');
                if (quiz) quiz.classList.add('hidden');
                if (wudhuChallenge) wudhuChallenge.classList.add('hidden');
                if (adminQuiz) adminQuiz.classList.add('hidden');
            });

            // Add search functionality
            document.addEventListener('input', (e) => {
                if (e.target.id === 'question-search') {
                    currentPage = 1;
                    displayQuestions();
                }
            });
        });
    </script>
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            background: none;
            overflow: hidden;
        }
        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #87CEEB url('https://yourusername.github.io/your-repo/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            z-index: -1;
        }
        .ui-container {
            position: relative;
            z-index: 1;
        }
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(90deg, #FFA500, #FF4500);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-bar h1 {
            color: #fff;
            font-size: 1.8rem;
            text-shadow: 2px 2px #000;
            animation: bounce 1s ease-out infinite;
        }
        .tree, .cloud, .star, .moon {
            position: absolute;
            animation: float 6s infinite ease-in-out;
            z-index: 1;
        }
        .tree { content: 'üå≥'; font-size: 80px; }
        .cloud { content: '‚òÅÔ∏è'; font-size: 50px; animation: float 8s infinite ease-in-out; }
        .star { content: '‚≠ê'; font-size: 30px; animation: twinkle 2s infinite alternate; }
        .moon { content: 'üåô'; font-size: 60px; animation: shine 4s infinite ease-in-out; top: 10%; left: 10%; }
        .hero {
            height: 100vh;
            position: relative;
            overflow: hidden;
            color: #fff;
            text-align: center;
            padding-top: 10rem;
            border-radius: 0 0 50px 50px;
            display: block;
            z-index: 10;
            background: none;
        }
        .hero h1 {
            font-size: 3.5rem;
            animation: bounce 1s ease-out;
        }
        .hero p {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeIn 1.5s ease-out;
        }
        .hero .btn {
            background: linear-gradient(90deg, #FFA500, #FF69B4);
            color: #fff;
            padding: 2rem 4rem;
            font-size: 2rem;
            border-radius: 30px;
            transition: transform 0.3s, background 0.3s;
            text-shadow: 1px 1px #000;
            z-index: 20;
            margin: 0.5rem;
        }
        .hero .btn:hover {
            transform: scale(1.1);
            background: linear-gradient(90deg, #32CD32, #87CEEB);
            box-shadow: 0 0 10px #32CD32;
        }
        .section {
            min-height: 100vh;
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            z-index: 10;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding-top: 80px;
            background: none;
        }
        .content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
            color: #000;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .admin-content {
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #FFA500 #ddd;
        }
        .admin-content::-webkit-scrollbar {
            width: 8px;
        }
        .admin-content::-webkit-scrollbar-track {
            background: #ddd;
            border-radius: 4px;
        }
        .admin-content::-webkit-scrollbar-thumb {
            background: #FFA500;
            border-radius: 4px;
        }
        .card-grid {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            padding: 4rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 20;
            flex-wrap: wrap;
        }
        .card {
            background: linear-gradient(135deg, #FF69B4, #FFA500);
            border-radius: 30px;
            padding: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            text-align: center;
            overflow: hidden;
            width: 250px;
            z-index: 20;
        }
        .card:hover {
            transform: translateY(-15px);
            box-shadow: 0 15px 40px rgba(50, 205, 50, 0.3);
        }
        .card h3 {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px #000;
        }
        .card p {
            color: #fff;
            text-shadow: 1px 1px #000;
        }
        .card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
            z-index: -1;
        }
        .btn {
            background: linear-gradient(90deg, #FFA500, #FF69B4);
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.2rem;
            transition: transform 0.3s, background 0.3s;
            text-shadow: 1px 1px #000;
            z-index: 1001;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .btn:hover {
            transform: scale(1.1);
            background: linear-gradient(90deg, #32CD32, #87CEEB);
            box-shadow: 0 6px 15px rgba(50, 205, 50, 0.5);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .star-counter {
            position: fixed;
            top: 70px;
            right: 1rem;
            background: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: #FFA500;
            z-index: 50;
            animation: pulse 2s infinite;
        }
        .avatar-display {
            position: fixed;
            top: 6rem;
            left: 1rem;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 5px solid #FFA500;
            object-fit: cover;
            animation: float 3s infinite ease-in-out;
            z-index: 50;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 201;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
            z-index: 20;
        }
        #progress {
            height: 100%;
            background: linear-gradient(90deg, #FFA500, #FF69B4);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 10px;
        }
        .badge {
            background: #FFD700;
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            margin: 0.5rem;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }
        .story-card {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: left;
            z-index: 20;
        }
        .placeholder-images {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px 0;
        }
        .placeholder-image {
            width: 400px;
            height: 300px;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            max-width: 800px;
            margin: 2rem auto;
        }
        .game-card {
            width: 100px;
            height: 100px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
        .game-card.flipped {
            transform: rotateY(180deg);
        }
        .game-card.matched {
            background: #90EE90;
            cursor: default;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            text-align: center;
            padding: 5px;
            border-radius: 10px;
        }
        .card-front {
            background: linear-gradient(135deg, #FFA500, #FF69B4);
            color: #fff;
            font-size: 2rem;
        }
        .card-back {
            background: #fff;
            color: #000;
            transform: rotateY(180deg);
            font-size: 0.8rem;
        }
        .wudhu-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 2rem auto;
        }
        .wudhu-act {
.wudhu-act {
    background: #fff;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    cursor: move;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.wudhu-act-content {
    display: flex;
    align-items: center;
    width: 100%;
}
.wudhu-act-number {
    background: #FFA500;
    color: #fff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}
.wudhu-type-select {
    width: 150px;
}
.level-section {
    margin-bottom: 1rem;
}
.level-section h4 {
    background: #FFA500;
    color: #fff;
    padding: 0.5rem;
    border-radius: 10px;
}
.level-questions {
    display: block;
}
.level-questions.hidden {
    display: none;
}
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-30px); }
    60% { transform: translateY(-15px); }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
    100% { transform: translateY(0); }
}
@keyframes twinkle {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}
@keyframes shine {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
}
@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.hidden { display: none; }
@media (max-width: 768px) {
    .hero h1 { font-size: 2rem; }
    .hero .btn { padding: 1rem 2rem; font-size: 1.2rem; }
    .card-grid { flex-direction: column; align-items: center; }
    .card { width: 80%; max-width: 300px; }
    .game-grid { grid-template-columns: repeat(4, 1fr); }
    .game-card { width: 80px; height: 80px; }
    .card-front, .card-back { font-size: 0.8rem; }
}
@media (max-width: 480px) {
    .hero h1 { font-size: 1.5rem; }
    .hero p { font-size: 1rem; }
    .hero .btn { padding: 0.8rem 1.5rem; font-size: 1rem; }
    .section { padding: 2rem 1rem; }
    .content { padding: 1rem; }
    .game-grid { grid-template-columns: repeat(3, 1fr); }
    .game-card { width: 60px; height: 60px; }
    .card-front, .card-back { font-size: 0.7rem; }
    .avatar-display { width: 80px; height: 80px; }
}